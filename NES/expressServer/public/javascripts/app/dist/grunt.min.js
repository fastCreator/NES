/*! grunt 06-11-2015 */
var app=angular.module("app",["ui.router","ngAnimate","layoutController","indexController","shoppingCarController","goodsController","myGoodController","ngCookies"]);app.config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/index"),a.state("index",{url:"/index",templateUrl:"/views/partials/index",controller:"IndexController"}).state("goods",{url:"/goods",views:{"":{templateUrl:"/views/partials/goods",controller:"GoodsController"},"main@goods":{templateUrl:"/views/partials/goodsMainList"}}}).state("goods.goodDetailed",{url:"/detailed",views:{"main@goods":{templateUrl:"/views/partials/goodDetailed",controller:"MyGoodController"}}}).state("goods.goodDetailed.page1",{templateUrl:"/views/partials/shopPage1"}).state("goods.goodDetailed.page2",{templateUrl:"/views/partials/shopPage2"}).state("goods.goodDetailed.page3",{templateUrl:"/views/partials/shopPage3"}).state("goods.goodDetailed.page4",{templateUrl:"/views/partials/shopPage4"}).state("goods.goodDetailed.page5",{templateUrl:"/views/partials/shopPage5"}).state("shoppingCar",{url:"/shoppingCar",views:{"":{templateUrl:"/views/partials/shoppingCar"},"shoppingcar@shoppingCar":{templateUrl:"/views/partials/shoppingCarEmpty",controller:["$rootScope","$state",function(a,b){a.state="shoppingCar",a.items&&0!=a.items.length&&b.go("shoppingCar.shoppingcarFull1")}]}}}).state("shoppingCar.shoppingcarEmpty",{url:"Empty",views:{"shoppingcar@shoppingCar":{templateUrl:"/views/partials/shoppingCarEmpty",controller:"ShoppingCarController"}}}).state("shoppingCar.shoppingcarFull1",{url:"1",views:{"shoppingcar@shoppingCar":{templateUrl:"/views/partials/shoppingCarFull1",controller:"ShoppingCarController"}}}).state("shoppingCar.shoppingcarFull2",{url:"2",views:{"shoppingcar@shoppingCar":{templateUrl:"/views/partials/shoppingCarFull2",controller:["$rootScope","$scope","$state",function(a,b,c){b.buy=function(){a.name=b.name,a.remarks=b.remarks,a.phone=b.phone,c.go("shoppingCar.shoppingcarFull3")}}]}}}).state("shoppingCar.shoppingcarFull3",{url:"3",views:{"shoppingcar@shoppingCar":{templateUrl:"/views/partials/shoppingCarFull3",controller:["$rootScope","$scope","$state","$http",function(a,b,c,d){a.name&&a.phone||c.go("shoppingCar.shoppingcarFull2"),b.shop,b.shop1;var e=(new Date).getTime();d.get("/users/getMoney").success(function(a){b.myMoney=a.price}),b.allPrice=function(){b.shop=new Array(0),b.shop1=new Array(0);for(var c=0,d=0;d<a.items.length;d++)a.items[d].checked?(c+=a.items[d].numb*a.items[d].price,a.items[d].hasPost=!1,a.items[d].id=e+""+d,b.shop.push(a.items[d])):b.shop1.push(a.items[d]);return c=c.toFixed(2),parseFloat(c)},a.address=a.p,a.c&&(a.address+="/"+a.c,a.a&&(a.address+="/"+a.a,a.d&&(a.address+="/"+a.d))),b.buy=function(){0!=b.shop.length?b.myMoney-b.allPrice()>=0?d.post("/users/buy",{password:b.password,shops:b.shop,fare:a.fare,name:a.name,phone:a.phone,address:a.address,remarks:a.remarks,username:a.username}).success(function(){a.items=b.shop1,c.go("shoppingCar.shoppingcarFull4")}).error(function(){b.message="密码错误,请重新输入"}):b.message="账户余额不足，无法购买":b.message="请选择商品后购买"}}]}}}).state("shoppingCar.shoppingcarFull4",{url:"4",views:{"shoppingcar@shoppingCar":{templateUrl:"/views/partials/shoppingCarFull4",controller:["$scope",function(a){}]}}})}]);var layoutController=angular.module("layoutController",["ngCookies","selectAddress"]),indexController=angular.module("indexController",[]),goodsController=angular.module("goodsController",["ngCookies"]),myGoodController=angular.module("myGoodController",["ngCookies"]),shoppingCarController=angular.module("shoppingCarController",[]);layoutController.controller("LayoutController",["$scope","$rootScope","$cookies","$http","$state",function(a,b,c,d,e){if(b.title="欢迎来到NES购物商城",b.fare=20,b.username=c.get("username"),a.emailVerified=c.get("emailVerified"),a.loginOut=function(){d.post("/logout",{},{params:{access_token:c.get("access_token")}}),b.username=null,a.emailVerified=null,c.remove("userId"),c.remove("access_token"),c.remove("username"),c.remove("emailVerified"),b.items=null,"shoppingCar"==b.state&&(null==b.items||b.items=={}||0==b.items.length)&&e.go("shoppingCar.shoppingcarEmpty")},b.getSearch=function(){angular.element("#text").val()&&(b.searchText=angular.element("#text").val()),d.get("/goods",{params:{filter:{fields:{myId:!0,select:!0,displayName:!0,price:!0,introduce:!0},where:{searchText:{like:a.searchText}}}}}).success(function(a){a==[]||null==a||0==a.length?b.shops=!1:b.shops=a,0==a.length?angular.element("footer").css({position:"absolute",bottom:"-430px"}):a.length<5?angular.element("footer").css({position:"absolute",bottom:"-140px"}):angular.element("footer").css({position:"absolute",bottom:"-85px"})})},b.search_key=function(a){var c=window.event?a.keyCode:a.which;13==c&&(b.getSearch(),e.go("goods"))},a.emailVerified){var f="users/"+c.get("userId");d.get(f,{params:{filter:{fields:{shopping:!0}},access_token:c.get("access_token")}}).success(function(a){a.shopping?b.items=a.shopping:b.items=[]})}b.$watch("items",function(){if(null!=b.username){var a="users/"+c.get("userId");d.post(a,{shopping:b.items},{params:{access_token:c.get("access_token")}})}},!0),a.go3Dshop=function(){b.searchText="3D",angular.element("#text").val(b.searchText),c.put("searchText",b.searchText),b.title=b.searchText+"商品展示_NES商城",b.getSearch(),e.go("goods")}}]),indexController.controller("IndexController",["$scope","$rootScope",function(a,b){b.state="index"}]),goodsController.controller("GoodsController",["$scope","$rootScope","$state","$cookies",function(a,b,c,d){b.state="goods",b.searchText||(b.searchText=d.get("searchText"),angular.element("#text").val(b.searchText),b.getSearch()),a.goShopdetails=function(a){b.myId=b.shops[a].myId,d.put("myId",b.myId),c.go("goods.goodDetailed")}}]),myGoodController.controller("MyGoodController",["$scope","$rootScope","$state","$http","imgBoost","$cookies","$timeout",function(a,b,c,d,e,f,g){b.state="myGoodController",a.getMyShop=function(){d.get("/goods/findOne",{params:{filter:{where:{myId:f.get("myId")}}}}).success(function(d){b.myId=f.get("myId"),a.myshop=d,e.init(a.myshop.imgNumb-5),b.imgMyID=a.myshop.shopDetails[0],b.imgCount=a.myshop.shopDetails[1],c.go("goods.goodDetailed.page1")})},a.getMyShop(),a.addShop=function(){function c(){var a=angular.element("#ng-nav-bar .center"),b=angular.element(".shop #Goshop"),c=a.offset().top-b.offset().top+30,d=a.offset().left-b.offset().left;b.css("visibility","visible"),b.animate({top:c+"px",left:d+"px",opacity:"0"},{duration:1e3,queue:!1,complete:function(){b.css({top:"0",left:"0",opacity:"1",visibility:"hidden"})}})}if(a.emailVerified){var d="",e=!0;a.myshop.classify&&0!=a.myshop.classify.length&&(a.classfiy?d+=" "+a.classfiy:(alert("请选择"+a.myshop.classifyNumb[0]),e=!1),e&&(a["class"]?d+=" "+a["class"]:a.myshop.classifyNumb[1]&&(alert("请选择"+a.myshop.classifyNumb[1]),e=!1),e&&a.myshop.select&&(d=a.myshop.select+" "+d))),e&&(c(),g(function(){var c=angular.element(".goodsDetailed .right .numbs").val();b.items.push({myId:a.myshop.myId,info:d,price:a.myshop.price,checked:!0,numb:c})},1e3))}else alert("请登录")},a.init=function(a){a.link==b.myId&&angular.element(".img").eq(a.$index-1).addClass("select")},a.classifyNumb=0,a.select=function(b,c){var d=angular.element(c.target);a.classifyNumb=b,a.classfiy=d.text(),angular.element(".class>span>span").removeClass("select"),d.addClass("select")},a.select2=function(b){if(null!=a.classfiy){var c=angular.element(b.target);a["class"]=c.text(),angular.element(".class2>span>span").removeClass("select"),c.addClass("select")}},a.goLink=function(b){f.put("myId",b.target.name),a.getMyShop(),a.myshop=null}}]),shoppingCarController.controller("ShoppingCarController",["$cookies","$http","$timeout","$state","$scope","$rootScope",function(a,b,c,d,e,f){f.state="shoppingCar",f.items&&0!=f.items.length||d.go("shoppingCar.shoppingcarEmpty"),e.toshop=function(b){f.myId=b,a.put("myId",b),d.go("goods.goodDetailed")},e.allPrice=function(){for(var a=0,b=0;b<f.items.length;b++)f.items[b].checked&&(a+=f.items[b].numb*f.items[b].price);return a=a.toFixed(2),parseFloat(a)},e.checkAll=function(){for(var a=0;a<f.items.length;a++)if(!f.items[a].checked)return!1;return!0},e.checkChange=function(){if(e.checkAll())for(var a=0;a<f.items.length;a++)f.items[a].checked=!1;else for(var a=0;a<f.items.length;a++)f.items[a].checked=!0},e.add=function(a){f.items[a].numb++},e.reduce=function(a){f.items[a].numb>0&&f.items[a].numb--},e["delete"]=function(a){f.items.splice(a,1),0==f.items.length&&d.go("shoppingCar.shoppingcarEmpty")}}]),layoutController.directive("logo",function(){return{restrict:"E",template:'<div class="logo" title="回到首页" ui-sref="index"><img id="logoIMG" src="/images/logo.png"/><span id="logoFont">购物商城</span></div>',replace:!0}}),layoutController.directive("search",function(){return{restrict:"E",template:'<div id="search"><form><span class="glyphicon glyphicon-search"></span><input type="text" id="text" ng-model="searchText" ng-keydown="search_key($event)"><input id="buttom" type="button" value="搜索" ui-sref="goods" ng-click="getSearch()"></form></div>',replace:!0}}),layoutController.directive("mynav",function(){return{restrict:"E",templateUrl:"/views/partials/navBar",replace:!0}}),layoutController.directive("goodslist",["aServer",function(a){return{restrict:"E",templateUrl:"/views/partials/goodsList",replace:!0,link:function(){a.setA()}}}]),layoutController.directive("location",function(){return{restrict:"E",template:'<input id="location" select-address p="p" c="c" a="a" d="d" ng-model="xxx" placeholder="请选择所在地" type="text" class="form-control" ng-required="{true}"/>',replace:!0,link:function(){angular.bootstrap(document,["layoutController"])}}}),layoutController.directive("login",function(){return{restrict:"E",template:'<a href="/login", ng-if="!emailVerified">请登录</a><a ng-click="loginOut()" ng-if="emailVerified">{{username}}:退出登录</a>'}}),layoutController.directive("pageimgs",["$rootScope",function(a){return{restrict:"E",template:function(){for(var b="",c=0;c<a.imgCount;c++)b+="<img src='/images/shops/"+a.imgMyID+"_"+(c+1)+".jpg'/>";return b}}}]),app.service("aServer",["$rootScope","$state","$cookies",function(a,b,c){this.setA=function(){angular.element(".search a").bind("click",function(d){a.searchText=angular.element(d.target).html(),a.$apply(),c.put("searchText",a.searchText),a.title=a.searchText+"推荐_NES商城",a.getSearch(),b.go("goods")})}}]),app.service("imgBoost",["$rootScope","$state",function(a,b){this.init=function(a){angular.element(".imgMain").bind("mousemove",function(a){var b=a.offsetX+"px",c=a.offsetY+"px";angular.element(".boost>img").css({"transform-origin":b+" "+c,"-ms-transform-origin":b+" "+c,"-webkit-transform-origin":b+" "+c,"-moz-transform-origin":b+" "+c,"-o-transform-origin":b+" "+c})});var b=0,c=angular.element("#imgLeft"),d=angular.element("#imgRight");c.bind("click",function(){b>-67*a?(angular.element("#imgul>ul").css({transform:"translateX("+(b-=67)+"px)"}),d.css({color:"#999999"})):c.css({color:"#DDDDDD"})}),d.bind("click",function(){0>b?(angular.element("#imgul>ul").css({transform:"translateX("+(b+=67)+"px)"}),c.css({color:"#999999"})):d.css({color:"#DDDDDD"})});var e=angular.element("#imgul>ul>li");e.bind("mouseover",function(a){if(e.removeClass("selectImg"),"LI"==a.target.nodeName)var b=a.target;else var b=a.target.parentNode;angular.element(b).addClass("selectImg");var c=angular.element(b.childNodes[0]).attr("src");angular.element(".imgMain>img").attr("src",c),angular.element(".boost>img").attr("src",c)});var f=angular.element(".numbs");angular.element(".add").bind("click",function(){f.val(parseInt(f.val())+1)}),angular.element(".reduce").bind("click",function(){parseInt(f.val())>1&&f.val(parseInt(f.val())-1)});var g=angular.element(".paging>ul>li");g.bind("click",function(a){g.removeClass("clicked"),angular.element(a.target).addClass("clicked")})}}]);